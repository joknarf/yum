name: Update YUM Repo

on:
  push:
    branches:
      - main
    paths:
      - '*.rpm'   # triggers only when root RPMs change

permissions:
  contents: write
  pages: write         # for deploy-pages
  id-token: write      # REQUIRED for deploy-pages@v4

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # needed for pushing commits

    - name: Install createrepo and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y createrepo-c html-xml-utils

    - name: Run createrepo
      run: |
        mkdir -p repodata
        createrepo_c --update .

    - name: Generate index.html
      run: |
          echo "<html><head><title>Joknarf Tools Yum Repository</title><style>
          :root {
            color-scheme: light dark;
          }

          body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
                         'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 2rem;
            background: #ffffff;
            color: #111111;
          }

          table {
            border-collapse: collapse;
            width: 100%;
          }

          th, td {
            border: 1px solid #dddddd;
            padding: 8px;
          }

          th {
            background-color: #f5f5f5;
            text-align: left;
          }

          a {
            color: #0969da;
            text-decoration: none;
          }

          a:hover {
            text-decoration: underline;
          }

          @media (prefers-color-scheme: dark) {
            body {
              background: #0d1117;
              color: #c9d1d9;
            }

            table {
              border-color: #30363d;
            }

            th, td {
              border-color: #30363d;
            }

            th {
              background-color: #161b22;
            }

            a {
              color: #58a6ff;
            }
          }
          </style></head><body>" > index.html

          echo "<h1>Joknarf Tools Yum Repository</h1>" >> index.html
          echo "<table>" >> index.html
          echo "<tr><th>Package</th><th>Arch</th><th>Version</th><th>Build Date</th><th>Summary</th><th>Size</th></tr>" >> index.html

          for f in *.rpm; do
            name="$f"
            version=$(rpm -qp --qf '%{VERSION}-%{RELEASE}' "$f" 2>/dev/null || echo "unknown")
            arch=$(rpm -qp --qf '%{ARCH}' "$f" 2>/dev/null || echo "unknown")
            summary=$(rpm -qp --qf '%{SUMMARY}' "$f" 2>/dev/null || echo "unknown")
            build_epoch=$(rpm -qp --qf '%{BUILDTIME}' "$f" 2>/dev/null || echo "")
            build_date=$( [ -n "$build_epoch" ] && date -d "@$build_epoch" "+%Y-%m-%d %H:%M:%S" || echo "unknown" )
            size=$(du -h "$f" | cut -f1)

            echo "<tr>
              <td><a href=\"$f\">$name</a></td>
              <td>$arch</td>
              <td>$version</td>
              <td>$build_date</td>
              <td>$summary</td>
              <td>$size</td>
            </tr>" >> index.html
          done

          echo "</table></body></html>" >> index.html

    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add repodata index.html
        git diff --quiet && git diff --staged --quiet || \
        git commit -m "Update repodata and index.html [skip ci]"
        git push

    - uses: actions/configure-pages@v5
    - uses: actions/upload-pages-artifact@v3
      with:
        path: .
    - uses: actions/deploy-pages@v4

